# WEB-31-Yudin-highload
Курсовая работа по highload

Студент: Юдин Данила Антонович  
Группа: WEB-31 (осень 2025)  
Старший преподаватель: Александр Быков  

# TikTok
## 1. Выбор тематики и аудитории
**Тип сервиса**: Социальные медиа, видеохостинг, развлекательный сервис  
**Основные регионы**: США (135.79M), Индонезия (107.69M), Бразилия (91.75M), Россия (55.98M) [^1]  
**Количество зарегистрированных пользователей**: 2.249B [^2]  
**Расположение дата-центров**: США, Ирландия, Норвегия, Сингапур, Малайзия [^3]  
**Основной функционал MVP**:
1. Посмотреть видео-ролик
2. Поставить лайк/дизлайк
3. Подписаться на канал/добавить в избранное
4. Выложить ролик на свой канал
5. Написать комментарий
6. Система рекоммендаций на основе распознования настроения и удержании внимания  
**Дополнительный функционал**:  
7. Поиск ролика/аккаунта по ключевому слову (+фильтры)  
8. Система продвижения (поделиться/не рекоммендовать)  
9. Технология Duet & Stitch

**Особенности**:
1. Короткий формат видео-роликов
2. Система рекомендаций, заточенная на удержание внимания
3. Технология Duet & Stitch
4. Низкий порог входа

**Отличие от других видеохостингов сервисов**:  
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Другие популярные видеохостинги, такие как Youtube позиционируется как поисковая/архивная видео-платформа со средней продолжительностей видео в 10-15 минут, нацеленная на широкую аудиторию и разнообразие жанров. В то время как TikTok предлагает преимущественно развлекательный контент длительностью ролика менее 60 секунд, нацеленная на молодежный сегмент.  
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Таким образом, Youtube - более универсальный сервис, который не имеет строго определенной аудитории, обладающим большим спектром возможностей - от обучения и развлечений до просмотра политических новостей, однако TikTok предлагает совершенно иной опыт - короткие развлекательные ролики, не требующие долгого фокуса и внимания, ориентированные на конкретные интересы и предпочтения.

**Конкуренция**:  
1. Youtube Shorts
2. Instagram Reels
3. Snapchat Spotlight

## 2. Расчет нагрузки

### Аудиторные метрики
Информация найдена в интернете. Все ссылки на источники будут расположены в конце РПЗ

| Метрика                                          | Значение      |
| ------------------------------------------------ | ------------- |
| MAU                                              | 1.582B [^4]   |
| DAU                                              | 875.736M [^5] |
| Количество зарегистрированных пользователей      | 2.249B [^2]   |
| Количество роликов выпускаемых в минуту          | 16000 [^8]    |

### Продуктовые метрики
Информация найдена путем личного эксперимента (кроме "средней продолжительности сессии"). Данные приблизительные и могут неточно отражать действительность.

| Метрика                                             | Значение       |
| --------------------------------------------------- | -------------- |
| Средняя продолжительность сессии                    | 53.8 мин [^6]  |
| Средняя продолжительность ролика                    | 42.7 сек [^11] |
| Среднее количество лайков/дизлайков на 1000 роликов | 34 [^10]       |
| Среднее количество подписок на 1000 роликов         | 1 [^10]        |
| Среднее количество комментариев на 1000 роликов     | 7  [^10]       |
| Среднее количество шейров на 1000 роликов           | 2  [^10]       |
| Среднее количество сохранений на 1000 роликов       | 5.6  [^13]     |
| Частота использования поисковой системы Тик Ток     | 73%  [^14]     |
| Частота использования технологии Duet/Stitch        | 19%  [^15]     |
| Среднее количество просмотров под роликом           | 32108  [^12]   |
| Среднее количество читаемых комментариев в день     | 15  [^17]      |
| Отношение читателей комментариев к общему           | 32%  [^18]     |
| Bitrate                                             | 7.5 Mbps       |

### Технические метрики
&nbsp;&nbsp;&nbsp;&nbsp;В качестве вводных был произведен расчет среднего количества просмотренных роликов одним пользователем в день (Предполагается, что пользователь на протяжении всей сессии только смотрел ролики), вес одного средне-статистического ролика и комментариев под ним:  


**Просмотров в день на одного пользователя**: &nbsp;&nbsp;
$\frac{\text{Продолжительность сессии}}{\text{Продолжительность ролика}} = \frac{53.8 \text{ мин}}{27.5 \text{ сек}} = \frac{3228 \text{ сек}}{27.5 \text{ сек}} \approx 76$  &nbsp;&nbsp;&nbsp;&nbsp;             **(1)**  
**Вес одного среднего по продолжительности ролика**:  &nbsp;&nbsp;
$\text{Вес ролика} = \text{Битрейт} \times \text{Продолжительность} = ( \frac{7.5}{8} ) \times 42.7 \approx 40 \text{ MB}$ &nbsp;&nbsp;&nbsp;&nbsp; **(2)**
**Среднее количество комментариев под роликом**:  &nbsp;&nbsp;
$\text{Среднее количество просмотров} \times \text{Вероятность коммментария} \approx 225 \text{ шт}$ &nbsp;&nbsp;&nbsp;&nbsp; **(3)**


Картина пользователя
| Тип запроса из MVP     | Среднее количество действий в день |
| ---------------------- | ---------------------------------- |
| Посмотреть видео-ролик | 76                                 |
| Поставить лайк/дизлайк | 2.584                              |
| Подписаться на канал   | 0.076                              |
| Выложить ролик         | 0.152                              |
| Написать комментарий   | 0.532                              |
| Добавить в избранное   | 0.4256                             |
| Поделиться             | 0.152                              |
| Поиск                  | 0.73                               |
| Технология Duet/Stitch | 0.0289                             |
| Чтение комментариев    | 15                                 |


### Хранилище


&nbsp;&nbsp;&nbsp;&nbsp;Для того, чтобы понять какой объем данных содержится на сервере на одного пользователя и общее количество информации необходимо узнать сколько роликов выходят на одного пользователя. По данным stata известно, что каждую минуту выходит 16000 роликов в минуту. Пересчитав это на день и поделив на DAU - станет явным, сколько роликов приходится на одного пользователя в день. Данный показатель является скоростью загрузки контента. Можно считать данную метрику постоянной, так как отражает лишь заинтресованность пользователя в развитии своего канала. Таким образом можно будет узнать сколько роликов было выпушено за все время на одного пользователя и каков этот объем данных:

**Количество новых роликов в день**:&nbsp;&nbsp;
$\text{Количество роликов в минуту} \times \text{Количество минут в дне} = 16000 \times 1440 \approx 23.04 \text{ млн}$&nbsp;&nbsp;&nbsp;&nbsp; **(4)**  
**Количество роликов на одного пользователя в день**:&nbsp;&nbsp;
$\frac{\text{Количество роликов в день}}{\text{DAU}} = \frac{23.04}{875.736} = 0.026$ &nbsp;&nbsp;&nbsp;&nbsp;**(5)**  
**Количество сохранений на одного пользователя в день**:&nbsp;&nbsp;**(6)**  
$\text{Количество роликов в день} \times \text{Вероятность сохранения} = 76 \times 0.002 = 0.152$  
**Количество сохранений на одного пользователя**:&nbsp;&nbsp;
$\text{Количество сохранений в день} \times \text{Среднее количество дней сущестования} = 0.152 \times 1643 = 249$ &nbsp;&nbsp;&nbsp;&nbsp;**(7)**  


| Год  | MAU          | Uploads    |
|------|--------------|------------|
| 2018 | 133 млн      | 1.27 млрд  |
| 2019 | 381 млн      | 3.63 млрд  |
| 2020 | 700 млн      | 6.67 млрд  |
| 2021 | 902 млн      | 8.6 млрд   |
| 2022 | 1,366 млрд   | 13.02 млрд |
| 2023 | 1,587 млрд   | 15.12 млрд |
| 2024 | 1,685 млрд   | 16.05 млрд |
| 2025 | 1.582 млрд   | 11.81 млрд |
| ***Итог***|         | ***76.7 млрд***|


**Средний размер хранилища пользователя (видео)**:&nbsp;&nbsp;
$\frac{\text{Количество роликов за все время}}{\text{Количество зарегистрированных}} = \frac{76.7}{2.249} \approx 34.1\text{ шт}$&nbsp;&nbsp;&nbsp;&nbsp; **(8)**  
**Общее количество комментариев под всеми роликами**:&nbsp;&nbsp;
$\text{Средний размер хранилища пользователя} \times \text{Кол-во комментариев} = 34.1 \times 225 \approx 7875\text{ шт}$&nbsp;&nbsp;&nbsp;&nbsp; **(9)**  
**Вес комментариев под всеми роликами**:&nbsp;&nbsp;
$\text{Среднее количество символов в комментарии} \times \text{кодировка UTF-8} \times \text{Количество комментариев} = 50 \times 1 \times 7875 = 384.5 \text{ KB}$$&nbsp;&nbsp;&nbsp;&nbsp; **(10)**  
**Средний размер хранилища пользователя (ГБ)**:&nbsp;&nbsp;  
$\text{Средний размер хранилища пользователя} \times \text{Вес ролика} = 34.1 \times 40 = 1.36\text{ GB}$&nbsp;&nbsp;&nbsp;&nbsp; **(11)**

&nbsp;&nbsp;&nbsp;&nbsp;Каждый пользователь имеет аватарку размерами либо 100х100, либо 200х200 пикселей в формате jpeg или png. Изображения с хорошей глубиной цвета такого размера в данных форматах весят около 20 килобайт. Мета-данные представляют собой название канала, его тег и 3 счетчика: количество подписчиков, количество подписок и количестов лайков. Название и тег весят в кодировке UTF-8 около 16 байт, а каждый счетчик по 8 байт.


| Тип данных  | Количество             | Хранилище пользователя    | Хранилище общее |
|-------------|------------------------|---------------------------|-----------------|
| Аватарка    | 1                      | 20 KB                     | 41.89 TB        |
| Мета-данные | 16 + 16 + 8*3 символов | 56 B                      | 117.29 GB       |
| Ролики      | 35                     | 1.36 GB                   | 2917 PB         |
| Комментарии | 385                    | 384.5 KB                  | 806.35 TB       |
| Сохраненки  | 249                    | 4.86 MB                   | 10.19 PB        |
| ***Итог***  |                        | ***1.365 GB***            | ***2929 PB***   |


### RPS


&nbsp;&nbsp;&nbsp;&nbsp;Очередным этапом стала оценка количества запросов на чтение и запись в день. Для этого были умножены следующие метрики: количество активных пользователей в день, количество просмотров в день на одного пользователя и вероятность на 1000 роликов лайков/дизлайков, подписок, комментариев.  

**Количество лайков в день**:&nbsp;&nbsp;
$\text{DAU} \times \text{Просмотров на пользователя} \times \text{Вероятность лайка} = 875.736 \times 10^6 \times 76 \times 0.034 \approx 2.263 \text{ млрд}$&nbsp;&nbsp;&nbsp;&nbsp; **(12)**  
**Количество комментов в день**:   
$\text{DAU} \times \text{Просмотров на пользователя} \times \text{Вероятность коммента} = 875.736 \times 10^6 \times 76 \times 0.007 \approx 465.9 \text{ млн}$$&nbsp;&nbsp;&nbsp;&nbsp; **(13)**  
**Количество подписок в день**:   
$\text{DAU} \times \text{Просмотров на пользователя} \times \text{Вероятность подписок} = 875.736 \times 10^6 \times 76 \times 0.001 \approx 66.56 \text{ млн}$&nbsp;&nbsp;&nbsp;&nbsp; **(14)**  
**Количество регистраций в день**:   
$\frac{\text{Количество скачиваний в год}}{\text{Количество дней в году}} = \frac{875.67 \times 10^6}{365} \approx 2.4 \text{ млн}$&nbsp;&nbsp;&nbsp;&nbsp; **(15)**  
**Количество шейров в день**:   
$\text{DAU} \times \text{Просмотров на пользователя} \times \text{Вероятность шейра} = 875.736 \times 10^6 \times 76 \times 0.002 \approx 133.102 \text{ млн}$&nbsp;&nbsp;&nbsp;&nbsp; **(16)**  
**Количество сохранений в день**:   
$\text{DAU} \times \text{Просмотров на пользователя} \times \text{Вероятность сохранения} = 875.736 \times 10^6 \times 76 \times 0.0056 \approx 372.714 \text{ млн}$&nbsp;&nbsp;&nbsp;&nbsp; **(17)**  
**Количество поисков в день**:   
$\text{DAU} \times \text{Вероятность поиска} = 875.736 \times 10^6 \times 0.73 \approx 639.287 \text{ млн}$&nbsp;&nbsp;&nbsp;&nbsp; **(18)**  
**Количество загрузок с Duet/Stitch в день**:   
$\text{Количество загрузок} \times \text{19%} = 23.04 \times 10^6 \times 0.19 \approx 4.378 \text{ млн}$&nbsp;&nbsp;&nbsp;&nbsp; **(19)**  
**Количество чтений комментариев в день**:   
$\text{DAU} \times \text{32% читателей} \times \text{Количество читаемых комментариев в день} = 875.736 \times 10^6 \times 0.32 \times 15 \approx 4.204 \text{ млрд}$&nbsp;&nbsp;&nbsp;&nbsp; **(20)**  

 
&nbsp;&nbsp;&nbsp;&nbsp;Заключительным этапом расчета технических метрик стало нахождение среднего и пикового RPS на чтение и запись. RPS на чтение определен из просмотров пользователя. Стоит принять во внимание, что ролики для просмотра грузятся одним стеком в 5 шт., а для расчета пикового RPS был взят коэффицент равный 2, так как сервера Tik Tok распределенны территориально по всему миру, к тому же наибольшее количество пользователей из стран Америки, Азии и Африки. Их часовые пояса сильно отличаются и пики посещаемости равномерно распологаются по 24 часам дня. Из-за чего пик неявно отражен:


**Количество запросов в день на просмотр роликов (RPD)**:&nbsp;&nbsp;  
$$\text{DAU} \times \text{Просмотров на пользователя} = 875.736 \times 10^6 \times 76 \approx 66.556 \text{ млрд}$$&nbsp;&nbsp;&nbsp;&nbsp; **(21)**   

**Средний RPS на чтение**:&nbsp;&nbsp;&nbsp;&nbsp;
$$\text{RPS}_{\text{avg}} = \frac{\text{RPD}}{86400 \text{ (секунд в дне)}} = \frac{66.556 \times 10^9}{86400} \approx 770324$$ &nbsp;&nbsp;  **(22)**  


|                      | Количество запросов в день | RPS среднее | RPS пиковое  |
|----------------------|----------------------------|-------------|--------------|
| Просмотр ролика      | 66.556 млрд                | 770324      | 1540648      |
| Выпуск ролика        | 23.04 млн                  | 267         | 534          |
| _Duet/Stitch_        | _4.378 млн_                | _51_        | _102_        |
| Лайк/дизлайк         | 2.263 млрд                 | 26193       | 52386        |
| Комментарий          | 465.9 млн                  | 5393        | 10786        |
| Подписка             | 66.56 млн                  | 771         | 1542         |
| Регистрация          | 2.4 млн                    | 28          | 56           |
| Поделиться           | 133.102 млн                | 1541        | 3082         |
| Добавить в избранное | 372.714 млн                | 4314        | 8628         |
| Поиск                | 639.287 млн                | 7400        | 14800        |
| Чтение комментариев  | 4.204 млрд                 | 48652       | 97304        |
| ***Итог***           | ***74.717 млрд***          | ***864883***| ***1723911***|

### Трафик


&nbsp;&nbsp;&nbsp;&nbsp;Следующим шагом стал расчёт трафика. Для этого был высчитан трафик на каждое возможное действие MVP и перемножив его с RPS средним и пиковым - можно получить среднюю и пиковую нагрузку на сервер:  
	1. Лайк/Дизлайк: {liker_id: bigint; video_id: bigint; created_at: timestamp; status: bool;}  -> 92 символа -> (В unicode) 92 Byte  
	2. Подписка: {follower_id: bigint; followee_id: bigint; created_at: timestamp;}  -> 78 символов -> (В unicode) 78 Byte  
	3. Комментарий: {senter_id: bigint; video_id: bigint; created_at: timestamp; body: {avg_len=25}}  -> 130 символов -> (В unicode) 130 Byte  
	4. Регистрация: {username: {text=16}; email: {text=16}; password: {text: 16} created_at: timestamp;}  -> 111 символов -> (В unicode) 111 Byte  
	5. Поделиться: {sharer_id: bigint; target_id: bigint; video_id: bigint; created_at: timestamp;}  -> 96 символов -> (В unicode) 96 Byte  
	6. Добавить в избарнное: {user_id: bigint; video_id: bigint; created_at: timestamp; status: bool}  -> 92 символа -> (В unicode) 92 Byte  
	7. Поиск: 10 роликов. В каждом: превью(20 KB), мета-данные(16+8+50=74 B) -> 20.072 KB * 10 = 200.72 KB  


|                             | Трафик на действие | Нагрузка            | Пиковая нагрузка |
|-----------------------------|--------------------|---------------------|------------------|
| Просмотр ролика             | 40 MB              | 29.38 TB/сек        |  58.76 TB/сек    |
| Выпуск ролика               | 40 MB              | 10.43 GB/сек        |  20.86 GB/сек    |
| Выпуск ролика c Duet/Stitch | 40 MB              | 1.99 GB/сек         |  3.98 GB/сек     |
| Лайк/дизлайк                | 92 B               | 2.3 MB/сек          |  4.6 MB/сек      |
| Написать комментарий        | 130 B              | 685 KB/сек          |  1.34 MB/сек     |
| Прочитать комментарий       | 130 B              | 6.03 MB/сек         |  12.06 MB/сек    |
| Подписка                    | 78 B               | 58.73 KB/сек        |  117.46 KB/сек   |
| Регистрация                 | 111 B              | 3.04 KB/сек         |  6.08 KB/сек     |
| Поделиться                  | 96 B               | 144.47 KB/сек       |  289 KB/сек      |
| Добавить в избранное        | 92 B               | 387.6 KB/сек        |  775.17 KB/сек   |
| Поиск                       | 200.72 KB          | 1.417 MB/сек        |  2.83 MB/сек     |


## 3. Глобальная балансировка нагрузки


&nbsp;&nbsp;&nbsp;&nbsp;Для того чтобы определиться с количеством и расоложением дата-центров, необходимо проанализировать в первую очередь территориальную распределенность по странам, регионам и континентам. Эта информация поможет найти плотность пользователей на территории, и, как следствие - места с наименьшей задержкой и количеством хопов.  


| Страна    | Регион           | Количество зарегистрированных |
|-----------|------------------|----------|
| США       | Северная Америка | 136 млн  |
| Индонезия | Азия             | 108 млн  |
| Бразилия  | Южная Америка    | 91.7 млн |
| Мексика   | Северная Америка | 88.4 млн |
| Пакистан  | Азия             | 66.9 млн |
| Филиппины | Азия             | 62.3 млн |
| Россия    | Европа           | 56.0 млн |
| Бангладеш | Азия             | 46.5 млн |
| Египет    | Африка           | 41.3 млн |
| Вьетнам   | Азия             | 40.9 млн |


&nbsp;&nbsp;&nbsp;&nbsp;Для приоритизации и определения количества дата-центров был произведен расчет доли нагрузки на регион от общей. Допустим, что каждый дата-центр для безопасности будут одинаковой мощности и обладать одинаковым количеством серверов. Примем за лимит нагрузки на один дата-центр - 5+-1%, и из этого расчитаем количество дата-центров на регион.  


| Регион           | Доля от мирового | Распределение RPS | Количество ДЦ | Нагрузка на 1 ДЦ |
|------------------|------------------|-------------------|---------------|------------------|
| Азия             | 36%              | 311.358           | 7             | 44480 (5.14%)    |
| Северная Америка | 12%              | 103.786           | 3             | 34596 (4%)       |
| Южная Америка    | 10%              | 86.488            | 2             | 43244 (4.99%)    |
| Европа           | 10%              | 86.488            | 2             | 43244 (4.99%)    |
| Африка           | 11%              | 95.137            | 2             | 47569 (5.5%)     |


&nbsp;&nbsp;&nbsp;&nbsp;Чтобы найти наилучшее расположение дата-центров нужно проанализировать плотность активных пользователей интернета. Это позволит найти точки с наибольшим сосредаточением количества соединений.  


### Плотность активных пользователей интернета
![ada5651d8964f4a7d007f34bccbf17a5_cropped_1332x810](https://github.com/user-attachments/assets/59f295c9-1b40-4c62-ba60-9f670537d317)


&nbsp;&nbsp;&nbsp;&nbsp;Если узнать в каких странах сосредаточено наибольшее количество зарегистрированных пользователей Тик Тока, зная плотность пользователей всего интернета - можно определиться с расположением серверов.


### География регистраций (10 стран)
![Tik tok](https://github.com/user-attachments/assets/572f70bf-f2a0-47b0-8988-897eb102474c)


| Регион           | Страна расположения ДЦ | Административная единица ДЦ |
|------------------|------------------------|-----------------------------|
| Азия             | Индонезия              | Джакарта                    |
| Азия             | Вьетнам                | Ханой                       |
| Азия             | Сингапур               | Сингапур                    |
| Азия             | Япония                 | Токио                       |
| Азия             | Пакистан               | Исламабад                   |
| Азия             | Китай                  | Гонконг                     |
| Азия             | Китай                  | Пекин                       |
| Северная Америка | США                    | Северная Вирджиния          |
| Северная Америка | США                    | Хилсборо                    |
| Северная Америка | Мексика                | Мехико                      |
| Южная Америка    | Бразилия               | Сан-Паулу                   |
| Южная Америка    | Аргентина              | Буэнос-Айрес                |
| Европа           | Ирландия               | Дублин                      |
| Европа           | Норвегия               | Хамар                       |
| Африка           | ЮАР                    | Йоханнесбург                |
| Европа           | Турция                 | Стамбул                     |


### Расположение дата-центров Тик Тока
![Main](https://github.com/user-attachments/assets/96890218-5978-4d84-a171-cfbceb83d232)


### Схема DNS балансировки
&nbsp;&nbsp;&nbsp;&nbsp;Для такого сервиса как Тик Ток был выбран тип DNS балансировки - **GeoDNS**. Принцип GeoDNS заключается в том, что ответ DNS-сервера зависит от географического местоположения источника запроса. Когда DNS-резолвер  отправляет запрос к GeoDNS-системе TikTok, система анализирует IP-адрес этого резолвера. По специальной базе данных GeoDNS определяет, из какого региона пришел запрос. На основе этого определения возвращается соответствующий этой локации IP-адрес.  


**Преимущества**:  
	1. Минимальная задержка  
	2. Эффективное распределение нагрузки  
	3. Соблюдение юрисдикций  


**Разделение трафика**:  
	1. api.tiktok.com - Все api запросы на получение и запись мета-данных  
	2. cdn.tiktok.com - Все запросы на чтение и запись медиа-контента  


### Схема BGP Anycast балансировки
&nbsp;&nbsp;&nbsp;&nbsp;Если GeoDNS направляет пользователя на правильный дата-центр, то Anycast направляет его к конкретному входному узлу внутри сетевой инфраструктуры, обеспечивая еще более тонкую и быструю оптимизацию. Принцип Anycast: один и тот же IP-адрес анонсируется в интернет одновременно из нескольких, географически распределенных точек.


**Преимущества**:  
	1. Максимальная отказоустойчивость и прозрачное восстановление    
	2. Встроенная балансировка нагрузки  
	3. Снижение задержки  


## 4. Локальная балансировка нагрузки


**Особенности инфраструктуры Tik Tok:**  
	1. Высокий приоритет по пропускной способности и задержки для загрузки видео  
	2. Много параллельных соединений (upload)  
	3. Региональная дистрибуция  


**Концепция:**  
&nbsp;&nbsp;&nbsp;&nbsp; Для того, чтобы ускорить процесс загрузки и выгрузки медиа-контента, я воспользуюсь CDN Cloundflare, для api - система из L7-балансировщиков. geoDNS взависимости от домена определит к какому типу трафика относится запрос и зарезолвит, если это api - то на L7 балансировщики, а в случае cdn на CDN pop. Origin CDN - будет использовано хранилище S3. Для ускорения сети можно закешировать запросы на CDN.   


**Количество L7 балансировщиков:**  
&nbsp;&nbsp;&nbsp;&nbsp;Из п.3 известно, что максимальная нагрузка на 1 дата-центр - 40k RPS. При этом по API нагрузка на хранилище - порядка 100 MB/s. С такой нагрузкой вполне может справится 1 хорошо настроенный и оборудованный L7 балансировщик. Но для отказоустойчивости воспользуемся формулой (N+1) и в резерв будет взят дополнительно еще 1 экземпляр. **Итоговое количество: 2**.  

**Назначение L7 балансировщиков:**  
	1. SSL-терминация  
	2. API Gateway  
	3. Health Check  
	4. Smart алгоритмы балансировки  


**Количество L4 балансировщиков:**  
&nbsp;&nbsp;&nbsp;&nbsp;Так как количество L7 балансировщиков всего 2, и один из них резервный, а также учитывая пробелему потери SSL-сессии при использовании L4 системы балансировки - было принято решение не использовать данный вид балансировки. **Итоговое количество - 0**.  


**Система балансировки:**  
&nbsp;&nbsp;&nbsp;&nbsp;На L7 балансировщик будет накатан k8s, Envoy istio. Весь бэкенд разделен на сервисы с определенным количеством pod(ов). Функцию SSL-терминацию берет  Envoy gateway. Kubernetes API отслеживает состояние сервисов, подов. Для межсервисного взаимодействия использован service mesh с сервисной сеткой istio. Для резолва url - CoreDNS (kube-dns). Для конфигурации envoy требуется Control Plane (Isitiod). Над каждым pod(ом) ставится envoy proxy (envoy sidecar).    


**Межсервисное взаимодействие:**  
&nbsp;&nbsp;&nbsp;&nbsp;pod X из сервиса A делает запрос на сервис B.  
	1. IP адрес не известен - делается запрос на coreDNS. Там он резолвится в ClusterIP.  
	2. Трафик перехватывает Envoy proxy и получая список актуальных ip подов от Istiod - envoy выбирает по алгоритму least connections под нужного сервиса.  
	3. TCP соединение устанавливается через kube-proxy на pod Y сервиса B.   
	4. Устанавливается mTLS между Envoy A и В. Далее трафик направляется в pod Y.  


### Отказоустойчивость   
&nbsp;&nbsp;&nbsp;&nbsp;Для быстрого восстановления после падения L7 балансировщика можно воспользоваться keep-alive балансировкой соединений - протоколом VRRP, который устанавливает на несколько балансировщиков, каждый из которых имеет определенную роль (master, standby), один виртуальный ip. Master имеет актуальный MAC и IP и весь трафик проходит через него. В то время как Standby регулярно проверяет состояние мастера с помощью протокола ARP. В случае если ответа не поступает - смена MAC и оповещение всех о смене master.  
&nbsp;&nbsp;&nbsp;&nbsp;В случае, если падает pod - Kubernetes API отследит падение и внесет правки реестр. Для дополнительной защиты Envoy sidecar может проверить состояние pod в service mesh.  
	**VRRP** (Virtual Router Redundancy Protocol)  
	**Service discovery Kubernetes**    


### SSL-терминация  
&nbsp;&nbsp;&nbsp;&nbsp;Для расшифровки HTTPS трафика на прокси-сервере воспользуемся SSL-терминацией. Существует 2 типа возобновления SSL-сессий: session id и session ticket. Первый вариант устаревший и редко используется. Поэтому воспользуемся **session ticket**, который работает на TLS 1.3. Для решения проблемы потери SSL-сессии, можно вопсользоваться технологией **sticky session**, который позволяет закешировать пользователя на определенный pod, для того, чтобы 1 пользователь с 1 типом запроса попадал на один и тот же pod, тем самым оптимизируя работу с установлением соединения TLS. Данную конфигурацию можно установить на Service Mesh.  


## 5. Логическая схема базы данных    


[![Логическая схема базы данных](https://github.com/user-attachments/assets/cce2625d-d0e6-45a5-b035-a5fa25baf5e8)](https://mermaid.live/view#pako:eNqtVttu4jAQ_ZXIUt9oBYVCyRuXtJtdARUJaFUhRSYewGoSI8eBdin_vg6BkGuXrchTkhmPz5w5M_YO2YwAUhHwPsVLjt2Zp8hnYmhjZRe9H74nel-hRHn5df437Yx7PzpjJfCBe9iFvGWNfX_LOMlbwMXUOf_WhpOB4gssAj_vizdYYG4FPLGgqz_rQ1NZMMdhW-B-iYV6y7PF1H6bypyyTFbgzoEQ6WnJ_J6O-e1nXvQy1fvaKMfEhhJgVoaPgyUkIxkomYigwoEMHgK-zelaUOblF0TbpBKPY60Cd-5JEtNmUx9ohtkZvJivSrB2GCYWwQIyINeYgyesUxaZOoiPNeT43FDY-pbNAk_kbA59gzKbzVxX7pUzX0B9qEHL0AxDHw1zFfDB9yVnVokmBXsD74LSJPmyOUiqiIVFGZ_kSzu8rymXRJzscSK90WCgSS6yORy5uVhHaeml0gilJOBdXJ5ZUggnCaRVb421Ts8sIj_CIIPaoqAG38BfoLuv8GeZLUd6ovh7WBMFugZaY9I1emP9pRCpH8zjSVCI8ugwL8O6wp4Hzv8IPAb21JmOJmPd1HKoFnjDAk4FXEOkCSiYkCIg2rSoT2BznS75R90EdUGeQe46E4vDAmSb2JAaldkplNzopzEaduVoF3I--9kUB12t39eHz9ZAMzv5XJMjsWiyufK8dqz0eRsO2uj_Rp6F6aNE65kjeZKALRi_ztyLU7m5Ucbg4FCxfuLa8Pl5e8t2x5NTPR5DBQ6p-a4qK1zgcxqdqrINVVi2zXkAqMqh1ctDXeKaalT13HkFrufWUc_NUuAXKVtVBKfLZXxhiTjK5RpTkbLnMi12SyKiXoHDCQoPawekUJaJEoUl9GX55x9fecbVPrmiClpySpC6wI4PFeQCl3c--Y0Okp8hsQKpYaTKVwILHDhihmbeXq5bY--VMRepggdyJWfBchXHidR4vKzGLuAR4L3wioHUWqPaOARB6g69y-9W667VqjXv2-1Gs9auNu4r6AOprfpd66HWrjXr7Ub1sd2831fQn8O2tbvqQ6Peemw22s16_aEpowGhsn8G0V35cGXe_wU0ajut)


Картинка кликабельна.


### Объем базы данных



1. **users**: Количество зарегистрированных пользователей [^2]  
2. **videos**: Количество загруженных роликов (7)  
3. **user_session**: Количество уникальных пользоватей месяца MAU [^4]  
4. **comment**: $\text{Количество роликов (7)} \times \text{Среднее количество комментариев под роликом (3)} = 76.7B \times 225 \approx 1.31\times10^{15}$  
5. **video_reaction**: $\text{Среднее количество просмотров [12]} \times \text{Количество роликов (7)} \times{Частота комментариев [10]} = 32108 \times 76.7B \times 0.034 \approx 6.36\times10^{15}$  
6. **comment_reaction**: Данные не найдены. Для упрощения взяты те же цифры что и video_reaction
7. **subscription**: $\text{Среднее количество просмотров [12]} \times \text{Количество роликов (7)} \times{Частота подписок [10]} = 32108 \times 76.7B \times 0.001 \approx 0.19\times10^{15}$  
8. **favourite**: $\text{Среднее количество просмотров [12]} \times \text{Количество роликов (7)} \times{Частота добавлений в избранное [10]} = 32108 \times 76.7B \times 0.0056 \approx 1.05\times10^{15}$
9. **event**: $\text{Сумма всех действий пользователя в день} \times \text{DAU} = 80.68 \times 875.736M \approx 70.655\times10^{9}$  
10. **embedding_meta**: $\text{Сумма всех пользователей} + \text{Сумма всех роликов} = 2.249B \times 76.7 \approx 78.949\times10^{9}$  


|      Таблица     | Объем одной записи | Количество записей   | Общий объем      | Расчет |
|------------------|--------------------|----------------------|------------------|--------|
| users            | 1931 Byte          | $2.249\times10^{9}$  |  4.342819 TB     | id(16) + username(64) + password(60) + email(255) + status(4) + avatar_url(500) + followers(8) + following(8) + bio(1000) + embedding_id(16) |
| videos           | 1620 Byte          | $76.7\times10^{9}$   |  0.124254 PB     | video_id(16) + user_id(16) + title(120) + description(1000) + video_url(200) + thumbnail_url(200) + upload_date(8) + parent_video_id(16) + type(4) + views_count(8) + likes_count(8) + comments_count(8) + embedding_id(16) |
| user_session     | 184 Byte           | $1.582\times10^{9}$  |  0.291088 TB     | session_id(16) + token(128) + user_id(16) + created_at(8) + updated_at(8) + expires_at(8) |
| comment          | 372 Byte           | $1.31\times10^{15}$  |  487.32 PB       | comment_id(16) + user_id(16) + video_id(16) + text(300) + created_at(8) + parent_id(16) |
| video_reaction   | 60 Byte            | $6.36\times10^{15}$  |  381.6 PB        | video_reaction_id(16) + user_id(16) + video_id(16) + type(4) + created_at(8) |
| comment_reaction | 60 Byte            | $6.36\times10^{15}$  |  381.6 PB        | comment_reaction_id(16) + user_id(16) + comment_id(16) + type(4) + created_at(8)|
| subscription     | 56 Byte            | $0.19\times10^{15}$  |  10.64 PB        | subscription_id(16) + subscriber_id(16) + channel_id(16) + created_at(8) |
| favourite        | 56 Byte            | $1.05\times10^{15}$  |  58.8 PB         | favourite_id(16) + user_id(16) + video_id(16) + added_at(8) |
| event            | 392 Byte           | $70.655\times10^{9}$ |  27.697 TB       | event_id(16) + user_id(16) + video_id(16) + type(4) + timestamp(8) + reference_id(16) + session_id(16) + details(jsonb 300) |
| embedding_meta   | 3236 Byte          | $78.949\times10^{9}$ |  255.479 TB      | embedding_id(16) + model_name(128) + model_version(4) + vector(3072) + created_at(8) + updated_at(8) |  


### Требования к консистентности  


1. **CONSTRAINTS:**


|      Таблица     | PK                  | FK                                     | NOT NULL                                                                                                         | UNIQUE                      |
|------------------|---------------------|----------------------------------------|------------------------------------------------------------------------------------------------------------------|-----------------------------|
| users            | id                  | embedding_id                           |  id, username, password, email, status, followers, following                                                     | username, email             |
| videos           | video_id            | user_id, parent_video_id, embedding_id |  video_id, user_id, title, video_url, thumbnail_url, upload_date, type, views_count, likes_count, comments_count |  -                          |
| user_session     | session_id          | user_id                                |  session_id, token, user_id, created_at, expires_at                                                              | token                       |
| comment          | comment_id          | user_id, video_id, parent_id           |  comment_id, user_id, video_id, text, created_at                                                                 | (user_id, comment_id)       |
| video_reaction   | video_reaction_id   | user_id, video_id                      |  video_reaction_id, user_id, video_id, type, created_at                                                          | (user_id, video_id)         |
| comment_reaction | comment_reaction_id | user_id, comment_id                    |  comment_reaction_id, user_id, comment_id, type, created_at                                                      | -                           |
| subscription     | subscription_id     | subscriber_id, channel_id              |  subscription_id, subscriber_id, channel_id, created_at                                                          | (subscriber_id, channel_id) |
| favourite        | favourite_id        | user_id, video_id                      |  favourite_id, user_id, video_id, added_at                                                                       | (user_id, video_id)         |
| event            | event_id            | user_id, video_id, session_id          |  event_id, user_id, type, timestamp, session_id                                                                  |  -                          |
| embedding_meta   | embedding_id        | -                                      |  embedding_id, model_name, model_version, vector, created_at                                                     |  -                          |  


2. **CHECK:**


|      Таблица     | CHECK                                                                                                                     |
|------------------|---------------------------------------------------------------------------------------------------------------------------|
| users            | followers >= 0; following >= 0; status IN ('active', 'banned', 'suspended')                                               |
| videos           | type IN ('original', 'duet', 'stitch'); views_count >= 0 AND likes_count >= 0 AND comments_count >= 0                     |
| user_session     | expires_at > created_at                                                                                                   |
| comment          | -                                                                                                                         |
| video_reaction   | type IN ('like', 'dislike')                                                                                               |
| comment_reaction | type IN ('like', 'complaint')                                                                                             |
| subscription     | subscriber_id != channel_id                                                                                               |
| favourite        | -                                                                                                                         |
| event            | type IN ('view', 'like', 'comment', 'share', 'subscribe', 'upload', 'dislike', 'favourite', 'unsubscribe', 'unfavourite') |
| embedding_meta   | -                                                                                                                         |  


3. **TRANSACTIONS:**  
	a. Транзакция загрузки видео (обновление мета-данных, создание event)  
	b. Транзакция обработки лайка (обновление мета-данных, создание event)  
	c. Транзакция подписки (обновление мета-данных, создание event)  
	d. Транзакция комментирования (обновление мета-данных, создание event)  

4. **TRIGGER, PROCEDURE:**  
	a. Триггер для автоматического обновления updated_at  
	b. Триггер для проверки дубликатов подписки  
	c. Процедура для удаления пользователя  
	d. Процедура для получения рекомендаций


## 6. Физическая схема базы данных   


[![Физическая схема базы данных](https://github.com/user-attachments/assets/ee418f0b-7861-49f1-8206-73ba9486710b)](https://www.mermaidchart.com/app/projects/60c75d35-635d-4b8a-953c-11d8467d5a57/diagrams/3864e5d6-7cfe-4815-b562-8aec0301abb7/version/v0.1/edit)


### Объемы данных       


| Метрика / Таблица | Расчёт (bytes)                                                                                                                                                                                                                                                     | Итог (bytes) |
| ----------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | -----------: |
| USER              | 16 (id) + 32 (username) + 64 (password) + 64 (email) + 4 (status) + 200 (avatar_url) + 200 (bio) + 16 (embedding_id)                                                                                                                                               |      **596** |
| USER_COUNTERS     | 16 (user_id) + 8 (followers_count) + 8 (following_count) + 8 (updated_at)                                                                                                                                                                                          |       **40** |
| VIDEO             | 16 (video_id) + 16 (user_id) + 100 (title) + 500 (description) + 200 (video_url) + 200 (thumbnail_url) + 8 (upload_date) + 16 (parent_video_id) + 4 (type) + 32 (username) + 200 (ava_url) + 100 (parent_video_title) + 200 (parent_video_url) + 16 (embedding_id) |     **1608** |
| VIDEO_COUNTERS    | 16 (video_id) + 8 (views_count) + 8 (likes_count) + 8 (comments_count) + 8 (favourites_count) + 8 (shares_count) + 8 (updated_at)                                                                                                                                  |       **64** |
| USER_SESSION      | 16 (session_id) + 64 (token) + 16 (user_id) + 8 (created_at) + 8 (updated_at) + 8 (expires_at)                                                                                                                                                                     |      **120** |
| COMMENT           | 16 (comment_id) + 16 (user_id) + 16 (video_id) + 300 (text) + 8 (created_at) + 16 (parent_id) + 32 (username) + 200 (ava_url)                                                                                                                                      |      **604** |
| COMMENT_COUNTERS  | 16 (comment_id) + 8 (likes_count) + 8 (updated_at)                                                                                                                                                                                                                 |       **32** |
| VIDEO_REACTION    | 16 (video_reaction_id) + 16 (user_id) + 16 (video_id) + 4 (type) + 8 (created_at)                                                                                                                                                                                  |       **60** |
| COMMENT_REACTION  | 16 (comment_reaction_id) + 16 (user_id) + 16 (comment_id) + 4 (type) + 8 (created_at)                                                                                                                                                                              |       **60** |
| SUBSCRIPTION      | 16 (subscription_id) + 16 (subscriber_id) + 16 (channel_id) + 8 (created_at)                                                                                                                                                                                       |       **56** |
| FAVOURITE         | 16 (favourite_id) + 16 (user_id) + 16 (video_id) + 8 (added_at)                                                                                                                                                                                                    |       **56** |
| EVENT             | 16 (event_id) + 16 (user_id) + 16 (video_id) + 4 (type) + 8 (timestamp) + 16 (reference_id) + 16 (session_id) + 256 (details JSONB)                                                                                                                                |      **348** |
| EMBEDDING_META    | 16 (embedding_id) + 64 (model_name) + 4 (model_version) + 6144 (vector) + 8 (created_at) + 8 (updated_at)                                                                                                                                                          |     **6244** |
| SEARCH_VIDEO      | 16 (search_id) + 16 (video_id) + 100 (title) + 200 (url) + 8 (likes) + 8 (upload_date) + 200 (author_ava) + 32 (author_username) + 16 (author_id) + 256 (TSVECTOR)                                                                                                 |      **852** |
| SEARCH_USER       | 16 (search_id) + 16 (user_id) + 32 (username) + 200 (bio) + 200 (ava_url) + 8 (followers) + 256 (TSVECTOR)                                                                                                                                                         |      **728** |  

<br><br>
### Индексы     


| Сценарий | Таблица | Поля индекса (составной / одиночный) | Объём одной записи (байт) | Количество записей | Общий объём индекса |
|---------|--------|--------------------------------------|---------------------------|---------------------|---------------------|
| **PK: `USER.id`** | `USER` | `id` (PK) | 16 | $2.249 \times 10^{9}$ | **35.98 GB** |
| **Уникальность пользователя** | `USER` | `username` (уникальный) | 28 | $2.249 \times 10^{9}$ | **62.97 GB** |
| **Найти `embedding_id` у пользователя** | `USER` | `embedding_id` | 16 | $2.249 \times 10^{9}$ | **35.98 GB** |
| **PK: `VIDEO.video_id`** | `VIDEO` | `video_id` (PK) | 16 | $76.7 \times 10^{9}$ | **1.23 TB** |
| **Найти родительский ролик по ролику** | `VIDEO` | `parent_video_id` | 16 | $76.7 \times 10^{9}$ | **1.23 TB** |
| **Быстрая отдача ролика (все поля для отображения)** | `VIDEO` | `video_id` (PK) → покрыто | **~360** | $76.7 \times 10^{9}$ | **27.61 TB** |
| **Найти все ролики пользователя** | `VIDEO` | `user_id, upload_date DESC` (составной) | 24 | $76.7 \times 10^{9}$ | **1.84 TB** |
| **PK: `COMMENT.comment_id`** | `COMMENT` | `comment_id` (PK) | 16 | $1.31 \times 10^{15}$ | **20.96 PB** |
| **Найти все комментарии к ролику** | `COMMENT` | `video_id, created_at DESC` (составной) | 24 | $1.31 \times 10^{15}$ | **31.44 PB** |
| **Для комментария найти родительский комментарий** | `COMMENT` | `parent_id, created_at DESC` (составной) | 24 | $1.31 \times 10^{15}$ | **31.44 PB** |
| **Подсчёт комментариев к видео** | `COMMENT` | `video_id` | 16 | $1.31 \times 10^{15}$ | **20.96 PB** |
| **Быстрая выдача комментария (все поля для отображения)** | `COMMENT` | `comment_id` (PK) → покрыто | **~230** | $1.31 \times 10^{15}$ | **301.30 PB** |
| **PK: `VIDEO_REACTION`** | `VIDEO_REACTION` | `video_reaction_id` (PK) | 16 | $6.36 \times 10^{15}$ | **101.76 PB** |
| **Уникальность лайка** | `VIDEO_REACTION` | `user_id, video_id` (составной, уникальный) | 32 | $6.36 \times 10^{15}$ | **203.52 PB** |
| **Подсчёт лайков на видео** | `VIDEO_REACTION` | `video_id, created_at DESC` (составной) | 24 | $6.36 \times 10^{15}$ | **152.64 PB** |
| **PK: `COMMENT_REACTION`** | `COMMENT_REACTION` | `comment_reaction_id` (PK) | 16 | $6.36 \times 10^{15}$ | **101.76 PB** |
| **Уникальность лайка на комментарий** | `COMMENT_REACTION` | `user_id, comment_id` (составной, уникальный) | 32 | $6.36 \times 10^{15}$ | **203.52 PB** |
| **Подсчёт лайков на комментарий** | `COMMENT_REACTION` | `comment_id, created_at DESC` (составной) | 24 | $6.36 \times 10^{15}$ | **152.64 PB** |
| **PK: `SUBSCRIPTION`** | `SUBSCRIPTION` | `subscription_id` (PK) | 16 | $0.19 \times 10^{15}$ | **3.04 PB** |
| **Уникальность подписки** | `SUBSCRIPTION` | `subscriber_id, channel_id` (составной, уникальный) | 32 | $0.19 \times 10^{15}$ | **6.08 PB** |
| **Найти все подписки пользователя** | `SUBSCRIPTION` | `subscriber_id, created_at DESC` (составной) | 24 | $0.19 \times 10^{15}$ | **4.56 PB** |
| **Найти всех подписчиков пользователя** | `SUBSCRIPTION` | `channel_id, created_at DESC` (составной) | 24 | $0.19 \times 10^{15}$ | **4.56 PB** |
| **Подсчёт подписчиков у пользователя** | `SUBSCRIPTION` | `channel_id` | 16 | $0.19 \times 10^{15}$ | **3.04 PB** |
| **Подсчёт подписок пользователя** | `SUBSCRIPTION` | `subscriber_id` | 16 | $0.19 \times 10^{15}$ | **3.04 PB** |
| **PK: `FAVOURITE`** | `FAVOURITE` | `favourite_id` (PK) | 16 | $1.05 \times 10^{15}$ | **16.80 PB** |
| **Уникальность избранного** | `FAVOURITE` | `user_id, video_id` (составной, уникальный) | 32 | $1.05 \times 10^{15}$ | **33.60 PB** |
| **Найти все избранные ролики пользователя** | `FAVOURITE` | `user_id, added_at DESC` (составной) | 24 | $1.05 \times 10^{15}$ | **25.20 PB** |
| **Подсчёт избранных у видео** | `FAVOURITE` | `video_id` | 16 | $1.05 \times 10^{15}$ | **16.80 PB** |
| **PK: `EMBEDDING_META`** | `EMBEDDING_META` | `embedding_id` (PK) | 16 | $78.949 \times 10^{9}$ | **1.26 TB** |
| **Быстрая выдача поиска ролика / избранного ролика** | `VIDEO` + `VIDEO_COUNTERS` | `video_id` → `LEFT JOIN` по PK | **~410** | $76.7 \times 10^{9}$ | **31.45 TB** |
| **Быстрая выдача поиска пользователя / подписчика / подписки** | `USER` + `USER_COUNTERS` | `id` → `LEFT JOIN` по PK | **~232** | $2.249 \times 10^{9}$ | **0.52 TB** |
| **`USER_COUNTERS`** | `USER_COUNTERS` | `user_id` (PK) | 16 | $2.249 \times 10^{9}$ | **35.98 GB** |
| **`VIDEO_COUNTERS`** | `VIDEO_COUNTERS` | `video_id` (PK) | 16 | $76.7 \times 10^{9}$ | **1.23 TB** |
| **`COMMENT_COUNTERS`** | `COMMENT_COUNTERS` | `comment_id` (PK) | 16 | $1.31 \times 10^{15}$ | **20.96 PB** |

<br><br>
### Шардирование/Партиционирование    


| Таблица | Стратегия | Поля |
|--------|----------|----------------|
| `USER` | **Шардирование** | `id` (UUID → hash) |
| `USER_COUNTERS` | **Шардирование** | `user_id` (с тем же шардом, что и `USER`) |
| `VIDEO` | **Шардирование** | `user_id` (владелец) |
| `VIDEO_COUNTERS` | **Шардирование** | `video_id` → тот же шард, что и `VIDEO` |
| `USER_SESSION` | **Шардирование** | `user_id` |
| `COMMENT` | **Партиционирование + Шардирование** | **Партиционирование**: `created_at` (по месяцам)<br>**Шардирование**: `video_id` → шард видео |
| `COMMENT_COUNTERS` | **Шардирование** | `comment_id` → тот же шард, что и `COMMENT` |
| `VIDEO_REACTION` | **Партиционирование + Шардирование** | **Партиционирование**: `created_at` (по неделям/месяцам)<br>**Шардирование**: `video_id` |
| `COMMENT_REACTION` | **Партиционирование + Шардирование** | **Партиционирование**: `created_at` (по месяцам)<br>**Шардирование**: `comment_id` → шард комментария |
| `SUBSCRIPTION` | **Шардирование** | `subscriber_id` или `channel_id` (по нагрузке) |
| `FAVOURITE` | **Шардирование** | `user_id` |
| `EVENT` | **Партиционирование** | `type` + `timestamp` (по дню/неделе) |
| `EMBEDDING_META` | **Шардирование** | `embedding_id` (UUID → hash) |


<br><br>
### СУБД    


| Таблица | СУБД |
|--------|------|
| **`USER`** | **Cassandra** |
| **`USER_COUNTERS`** | **Cassandra** |
| **`VIDEO`** | **Cassandra** | |
| **`VIDEO_COUNTERS`** | **Cassandra** |
| **`COMMENT`** | **Cassandra** |
| **`COMMENT_COUNTERS`** | **Cassandra** |
| **`USER_SESSION`** | **Redis** |
| **`VIDEO_REACTION`** | **Kafka** |
| **`COMMENT_REACTION`** | **Kafka** |
| **`SUBSCRIPTION`** | **Kafka** |
| **`FAVOURITE`** | **Kafka** |
| **`EVENT`** | **ClickHouse** |
| **`SEARCH_VIDEO`** | **Elasticsearch** |
| **`SEARCH_USER`** | **Elasticsearch** |
| **`EMBEDDING_META`** | **Melvus** | 


<img width="1162" height="783" alt="image" src="https://github.com/user-attachments/assets/85439d7b-0ac1-4303-ab11-86481da5c876" />


## 8. Стек технологий   


| Технология | Область применения |
|------------|--------------------|
| **React + TypeScript** | **Frontend (веб-интерфейс)**: Создание динамического UI. TypeScript — для типобезопасности. |
| **Go (Golang)** | **Backend (микросервисы)**: Основной язык для высоконагруженных API-сервисов. |
| **Kotlin** | **Мобильное приложение**: Язык, который позволит создать мобильное приложение под Android. |
| **Swift** | **Мобильное приложение**: Язык, который позволит создать мобильное приложение под iOS |
| **Python** | **ML / Рекомендации / Обработка данных**: Построение и обучение моделей рекомендаций, анализ поведения пользователей, интеграция с PyTorch/TensorFlow. |
| **Envoy + Istio** | **L7-балансировка и Service Mesh**: Умная маршрутизация трафика, mTLS, observability между микросервисами. Управление трафиком на уровне HTTP/gRPC. |
| **Docker + Kubernetes (K8s)** | **Контейнеризация и оркестрация**: Упаковка сервисов в контейнеры, автоматическое масштабирование, self-healing, управление конфигурацией. |
| **Cassandra** | **Хранение горячих данных**: Пользователи, видео, счётчики. Линейное масштабирование, высокая доступность, запись до 100K+ RPS. |
| **Redis** | **Кэш и сессии**: Хранение сессий пользователей, rate limiting. |
| **Kafka** | **Потоковая обработка событий**: Буферизация просмотров, лайков, комментариев, реакций. Асинхронная передача данных в ML-системы. |
| **S3** | **Хранение медиафайлов**: Видео, превью, аватары. Масштабируемое объектное хранилище с интеграцией CDN. |
| **Milvus** | **Векторный поиск**: Хранение и поиск эмбеддингов видео/пользователей (семантический поиск, рекомендации "похожие видео"). |
| **Elasticsearch** | **Полнотекстовый поиск**: Поиск по заголовкам, описаниям, тегам, пользователям. |
| **ClickHouse** | **Аналитика и события**: Хранение и анализ логов, просмотров, реакций, комментариев. Быстрые агрегации, партиционирование по дате, сжатие данных. |
| **Prometheus** | **Сбор метрик**: Мониторинг CPU, памяти, RPS, latency, ошибок по сервисам и контейнерам. |
| **Grafana** | **Визуализация метрик**: Дашборды для мониторинга здоровья системы, анализ производительности в реальном времени. |


## Список используемых источников:
[^1]: [Основные регионы по распространенности сервиса I](https://www.statista.com/statistics/1299807/number-of-monthly-unique-tiktok-users/), [Основные регионы по распространенности сервиса II](https://www.demandsage.com/tiktok-user-statistics/)
[^2]: [Количество зарегистрированных пользователей I](https://www.demandsage.com/tiktok-user-statistics/), [Количество зарегистрированных пользователей II](https://datareportal.com/reports/digital-2025-july-global-statshot)
[^3]: [Расположение дата-центров](https://dgtlinfra.com/tiktok-data-centers-cloud-locations/)
[^4]: [Количество активных пользователей за месяц I](https://www.statista.com/statistics/272014/global-social-networks-ranked-by-number-of-users/), [Количество активных пользователей за месяц II](https://en.wikipedia.org/wiki/List_of_social_platforms_with_at_least_100_million_active_users)
[^5]: [Количество активных пользователей за день](https://www.semrush.com/analytics/overview/?q=tiktok.com&searchType=domain&protocol=https&utm_source=explodingtopics.com&utm_medium=referral&utm_campaign=time-spent-on-tiktok)
[^6]: [Средняя продолжительность сессии](https://www.statista.com/statistics/1301075/us-daily-time-spent-social-media-platforms/)
[^7]: [Количество роликов, выкладываемых в минуту](https://www.statista.com/statistics/195140/new-user-generated-content-uploaded-by-users-per-minute/)
[^8]: [Количество роликов выпускаемых в минуту](https://www.statista.com/statistics/195140/new-user-generated-content-uploaded-by-users-per-minute/)
[^9]: [Количество скачиваний в год](https://www.statista.com/statistics/1377008/tiktok-worldwide-downloads-quarterly/)
[^10]: [Продуктовые метрики](https://www.socialinsider.io/social-media-benchmarks/tiktok)
[^11]: [Средняя продолжительность ролика](https://www.statista.com/statistics/1485205/tiktok-video-duration/)
[^12]: [Среднее количество просмотров](https://www.statista.com/statistics/1372502/tiktok-video-views-by-type-account/)
[^13]: [Среднее количество добавлений в избранное](https://www.shortformdata.com/blog/saves-are-the-secret-to-tiktok-search-ranking-in-2025)
[^14]: [Среднее количество поисков I](https://riseatseven.com/blog/tiktok-seo-statistics-in-2024/), [Среднее количество поисков II](https://www.adobe.com/express/learn/blog/using-tiktok-as-a-search-engine)
[^15]: [Отношение Duet/Stitch роликов ко всем](https://sqmagazine.co.uk/tiktok-vs-instagram-statistics/)
[^16]: [Среднее время установления TSL 1.3](https://blog.codavel.com/measuring-tls-1.3-performance)
[^17]: [Среднее количество читаемых комментариев в день](https://vk.com/@zen_monetize-kommentarii-uvelichivaut-vovlechennost-chitatelei?ysclid=mgny4jaml759244644)
[^18]: [Отношение читателей комментариев к общему](https://adindex.ru/news/tendencies/2025/06/4/334029.phtml?ysclid=mgnx98pab7851981479)

